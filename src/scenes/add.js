import { Telegraf, Scenes } from 'telegraf';

import { GENERAL_SCENES } from '../config/scenes.js';
import { backKeyboard, mainKeyboard } from '../config/keyboards.js';

let endMessage;

const linkHandler = Telegraf.on('message', async ctx => {
	const message = ctx.message.text;
	const urlParam = 's=104'
	const urlExp = /(http|https):\/\/(\w+:{0,1}\w*@)?(\S+)(:[0-9]+)?(\/|\/([\w#!:.?+=&%@!\-\/]))?/
	let link;

	if (message.match(urlExp)) {
		if (!message.includes(urlParam)) {
			if (!message.includes('?')) {
				link = message + '?' + urlParam;
			} else {
				link = message + '&' + urlParam;
			}
		} else {
			link = message;	
		}
	} else {
		await ctx.deleteMessage();
		return ctx.replyWithHTML('üî∏ <b>–°—Å—ã–ª–∫–∞ –¥–æ–ª–∂–Ω–∞ –±—ã—Ç—å –≤–∏–¥–∞: https://www.–∞vit–æ.ru/moskva_i_mo/muzy...</b>');
	}
	
	if (!ctx.session.links.find(l => l.link === link)) {
		ctx.session.link = link;

		await ctx.deleteMessage();
		await ctx.replyWithHTML('‚úèÔ∏è <b>–û—Ç–ª–∏—á–Ω–æ!</b> –¢–µ–ø–µ—Ä—å –≤–≤–µ–¥–∏—Ç–µ –Ω–∞–∑–≤–∞–Ω–∏–µ –∫–∞—Ç–µ–≥–æ—Ä–∏–∏:');
		
		return ctx.wizard.next();
	}
	return ctx.replyWithHTML('‚ùóÔ∏è <b>–£ –í–∞—Å —É–∂–µ –µ—Å—Ç—å —Ç–∞–∫–∞—è —Å—Å—ã–ª–∫–∞!</b>');
})

const linkNameHandler = Telegraf.on('message', async ctx => {
	const message = ctx.message.text;
	const userId = String(ctx.from.id);


	if (message !== '‚è™ –ù–∞–∑–∞–¥') {
		ctx.session.linkName = message;
		
		ctx.session.links.push({
			link: ctx.session.link,
			link_name: ctx.session.linkName
		});
		
		// await db.ref(`users/${userId}/links`).set(ctx.session.links);
		ctx.session.link = '';
		ctx.session.linkName = '';
		await ctx.deleteMessage();

		endMessage = '‚úÖ <b>–°—Å—ã–ª–∫–∞ —É—Å–ø–µ—à–Ω–æ –¥–æ–±–∞–≤–ª–µ–Ω–∞!</b>';
	}
	return ctx.scene.leave();
})

const addScene = new Scenes.WizardScene(GENERAL_SCENES.ADD, linkHandler, linkNameHandler);

addScene.enter(ctx => {
	endMessage = 'üî∏ <b>–î–æ–±–∞–≤–ª–µ–Ω–∏–µ –æ—Ç–º–µ–Ω–µ–Ω–æ.</b>';
	return ctx.replyWithHTML('üîó <b>–í–≤–µ–¥–∏—Ç–µ —Å—Å—ã–ª–∫—É:</b>', backKeyboard)
});

addScene.leave(ctx => ctx.replyWithHTML(endMessage, mainKeyboard(ctx)));

export default addScene;